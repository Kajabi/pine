import { Meta, Canvas, Controls } from '@storybook/addon-docs/blocks';
import * as stories from '../stories/pds-multiselect.stories.js';

import { DocArgsTable, DocCanvas } from '@pine-ds/doc-components';
import { components } from '../../../../dist/docs.json';

<Meta of={stories} />

# Multiselect

The multiselect component allows users to select multiple options from a searchable dropdown list. It displays selected items as removable chips in a Select2-style pillbox interface.

## Guidelines

### When to use
- When users need to select multiple items from a list
- When the list of options is long and benefits from search/filtering
- When you need to display selected items visually as tags/chips
- For tagging, categorization, or assigning multiple values

### When not to use
- For single selection - use `pds-combobox` or `pds-select` instead
- For very short lists (3-4 items) - consider using checkboxes directly
- When users need to create new options - consider a tag input component

### Accessibility
- Implements WAI-ARIA Combobox pattern with multiselect support
- Full keyboard navigation: Arrow keys, Enter, Escape, Backspace
- Screen reader announces selected count and available options
- Checkboxes in dropdown provide clear selection state

## Usage Notes

### Working with Labels

Text that appears above the multiselect is the component's label, not a separate `pds-text` component. The `label` prop creates accessible text that associates properly with the input.

## Properties

<DocArgsTable componentName="pds-multiselect" docSource={components} />

## Examples

### Default

Basic multiselect with static options.

<DocCanvas
  mdxSource={{
    webComponent: `<pds-multiselect
  component-id="tags-select"
  label="Select Tags"
  placeholder="Search tags..."
>
  <option value="1">Marketing</option>
  <option value="2">Sales</option>
  <option value="3">Support</option>
  <option value="4">Engineering</option>
</pds-multiselect>`,
    react: `<PdsMultiselect
  componentId="tags-select"
  label="Select Tags"
  placeholder="Search tags..."
>
  <option value="1">Marketing</option>
  <option value="2">Sales</option>
  <option value="3">Support</option>
  <option value="4">Engineering</option>
</PdsMultiselect>`,
  }}
>
  <pds-multiselect
    component-id="tags-select"
    label="Select Tags"
    placeholder="Search tags..."
  >
    <option value="1">Marketing</option>
    <option value="2">Sales</option>
    <option value="3">Support</option>
    <option value="4">Engineering</option>
  </pds-multiselect>
</DocCanvas>

### With Preselected Values

Use the `value` prop to set initially selected items.

<DocCanvas
  mdxSource={{
    webComponent: `<pds-multiselect
  component-id="departments-select"
  label="Departments"
  placeholder="Search departments..."
  value='["1", "3"]'
>
  <option value="1">Marketing</option>
  <option value="2">Sales</option>
  <option value="3">Support</option>
</pds-multiselect>`,
    react: `<PdsMultiselect
  componentId="departments-select"
  label="Departments"
  placeholder="Search departments..."
  value={['1', '3']}
>
  <option value="1">Marketing</option>
  <option value="2">Sales</option>
  <option value="3">Support</option>
</PdsMultiselect>`,
  }}
>
  <pds-multiselect
    component-id="departments-select"
    label="Departments"
    placeholder="Search departments..."
    value='["1", "3"]'
  >
    <option value="1">Marketing</option>
    <option value="2">Sales</option>
    <option value="3">Support</option>
  </pds-multiselect>
</DocCanvas>

### Max Selections

Limit the number of items that can be selected.

<DocCanvas
  mdxSource={{
    webComponent: `<pds-multiselect
  component-id="limited-select"
  label="Select Up to 3 Tags"
  placeholder="Search..."
  max-selections="3"
>
  <option value="1">Tag A</option>
  <option value="2">Tag B</option>
  <option value="3">Tag C</option>
  <option value="4">Tag D</option>
  <option value="5">Tag E</option>
</pds-multiselect>`,
    react: `<PdsMultiselect
  componentId="limited-select"
  label="Select Up to 3 Tags"
  placeholder="Search..."
  maxSelections={3}
>
  <option value="1">Tag A</option>
  <option value="2">Tag B</option>
  <option value="3">Tag C</option>
  <option value="4">Tag D</option>
  <option value="5">Tag E</option>
</PdsMultiselect>`,
  }}
>
  <pds-multiselect
    component-id="limited-select"
    label="Select Up to 3 Tags"
    placeholder="Search..."
    max-selections="3"
  >
    <option value="1">Tag A</option>
    <option value="2">Tag B</option>
    <option value="3">Tag C</option>
    <option value="4">Tag D</option>
    <option value="5">Tag E</option>
  </pds-multiselect>
</DocCanvas>

### Async with URL

Fetch options from a remote API endpoint. The component expects responses in the format `{ results: [{ id, text }], totalCount }`.

<DocCanvas
  mdxSource={{
    webComponent: `<pds-multiselect
  component-id="async-select"
  label="Search Products"
  placeholder="Type to search..."
  async-url="/api/products"
  debounce-ms="500"
/>`,
    react: `<PdsMultiselect
  componentId="async-select"
  label="Search Products"
  placeholder="Type to search..."
  asyncUrl="/api/products"
  debounceMs={500}
/>`,
  }}
>
  <pds-multiselect
    component-id="async-select"
    label="Search Products"
    placeholder="Type to search..."
  >
    <option value="1">Product A</option>
    <option value="2">Product B</option>
    <option value="3">Product C</option>
  </pds-multiselect>
</DocCanvas>

> **Note:** The live preview uses static options. In production, options are fetched from the API endpoint.

### Consumer-Managed Async

For complex async scenarios (React Query, custom caching), manage data externally and pass options via prop.

<DocCanvas
  mdxSource={{
    webComponent: `<pds-multiselect
  component-id="consumer-async"
  label="Contacts"
  placeholder="Search contacts..."
  .options="[{id: '1', text: 'Alice'}, {id: '2', text: 'Bob'}]"
  @pdsMultiselectSearch="handleSearch"
  @pdsMultiselectChange="handleChange"
/>`,
    react: `<PdsMultiselect
  componentId="consumer-async"
  label="Contacts"
  placeholder="Search contacts..."
  options={contacts}
  onPdsMultiselectSearch={(e) => setQuery(e.detail.query)}
  onPdsMultiselectChange={(e) => setSelected(e.detail.values)}
/>`,
  }}
>
  <pds-multiselect
    component-id="consumer-async"
    label="Contacts"
    placeholder="Search contacts..."
  >
    <option value="1">Alice Johnson</option>
    <option value="2">Bob Smith</option>
    <option value="3">Charlie Brown</option>
  </pds-multiselect>
</DocCanvas>

> **Note:** The live preview uses static options. In production, pass options via the `options` prop and listen to `pdsMultiselectSearch` events.

### With Error State

Display validation errors with the `errorMessage` prop.

<DocCanvas
  mdxSource={{
    webComponent: `<pds-multiselect
  component-id="error-select"
  label="Required Tags"
  placeholder="Search tags..."
  error-message="Please select at least one tag."
  invalid
>
  <option value="1">Tag A</option>
  <option value="2">Tag B</option>
</pds-multiselect>`,
    react: `<PdsMultiselect
  componentId="error-select"
  label="Required Tags"
  placeholder="Search tags..."
  errorMessage="Please select at least one tag."
  invalid
>
  <option value="1">Tag A</option>
  <option value="2">Tag B</option>
</PdsMultiselect>`,
  }}
>
  <pds-multiselect
    component-id="error-select"
    label="Required Tags"
    placeholder="Search tags..."
    error-message="Please select at least one tag."
    invalid
  >
    <option value="1">Tag A</option>
    <option value="2">Tag B</option>
  </pds-multiselect>
</DocCanvas>

## Keyboard Navigation

| Key | Action |
|-----|--------|
| `↓` / `↑` | Navigate through options |
| `Enter` | Select highlighted option |
| `Space` | Toggle checkbox of highlighted option |
| `Escape` | Close dropdown |
| `Backspace` | Remove last selected item (when input is empty) |
| `Tab` | Close dropdown and move focus |

## Form Integration

`pds-multiselect` is a form-associated custom element. It participates in form submission using the `name` attribute.

- Selected values are submitted as multiple entries with the same name (native `<select multiple>` behavior)
- Works with `FormData` API
- Supports form reset

## Events

| Event | Payload | Description |
|-------|---------|-------------|
| `pdsMultiselectChange` | `{ values: string[], items: Option[] }` | Fired when selection changes |
| `pdsMultiselectSearch` | `{ query: string }` | Fired on search input (debounced) |
| `pdsMultiselectLoadOptions` | `{ query: string, page: number }` | Fired when infinite scroll loads more |

## Playground

<Controls of={stories.Default} />
